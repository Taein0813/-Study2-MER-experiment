<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>음악 감정 평가 실험 (파일럿)</title>

  <!-- jsPsych core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

  <!-- plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>

  <style>
    body {
      max-width: 1100px;
      margin: 0 auto;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    }
    h1.main-title {
      text-align: center;
      margin: 18px 8px 8px;
      font-size: 26px;
      line-height: 1.3;
    }
    fieldset {
      margin-bottom: 20px;
      border: 1px dashed #a0a0a0;
      padding: 12px 18px;
      border-radius: 6px;
      background: #fafafa;
    }
    legend { font-weight: 600; padding: 0 6px; }
    .trial-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      margin-top: 12px;
    }
    .left-pane { flex: 1.2; text-align: left; }
    .right-pane { flex: 1; }
    .top-instruction {
      text-align: center;
      margin-bottom: 10px;
      border: 1px dashed #ccc;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
    }
    .jspsych-btn { padding: 6px 16px; }
    .slider-row { margin: 8px 0 18px 0; font-size: 13px; }
    .slider-label-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
    }
    .slider-label-line span { flex: 1; text-align: center; }
    .slider-label-line span:first-child { text-align: left; }
    .slider-label-line span:last-child { text-align: right; }
    .slider-wrap { position: relative; width: 100%; margin-top: 6px; }
    .slider-wrap input[type="range"] { width: 100%; margin: 0; }
    .slider-wrap .mid-tick {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 130%;
      background: #777;
      pointer-events: none;
    }
    .progress-text {
      text-align: right;
      font-size: 13px;
      margin: 6px 4px 4px;
      color: #555;
    }
    .info-text { font-size: 13px; line-height: 1.7; margin-top: 12px; }
    #jspsych-survey-html-form-next { margin-bottom: 40px; }
    [id^="jspsych-html-button-response-button"] { margin-bottom: 40px; }

    .textarea {
      width: 100%;
      min-height: 220px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.6;
      border-radius: 8px;
      border: 1px solid #cfcfcf;
      box-sizing: border-box;
      resize: vertical;
      background: #fff;
    }

    @media (max-width: 900px) {
      .trial-layout { flex-direction: column; }
      .left-pane, .right-pane { width: 100%; }
    }
  </style>
</head>

<body>
  <div id="jspsych-target"></div>

  <script>
    // -----------------------------
    // 0. 제출 받을 Google Apps Script Web App URL
    // -----------------------------
    const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbx15kYuTQuzEXWxZnghgcGFXiYIDdUJq_LnQ-iXUmwAUZE5Jpy_gcvBMfqsnhQH4ZNN/exec";

    // 제출 요청이 "보내졌음"을 표시하는 플래그 (no-cors라 성공/실패 확정 확인은 불가)
    let submitRequested = false;

    // -----------------------------
    // 1. jsPsych 초기화
    // -----------------------------
    const jsPsych = initJsPsych({
      display_element: "jspsych-target",
      on_finish: function () {
        const csv = jsPsych.data.get().csv();

        const now = new Date();
        const submitted_at = now.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
        const submitted_iso = now.toISOString();

        // no-cors: 저장 요청 전송은 되지만, 브라우저가 응답 내용을 읽을 수는 없음
        fetch(SUBMIT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            subject_id: subject_id,
            name: participant_name,
            csv: csv,
            submitted_at: submitted_at,
            submitted_iso: submitted_iso,
          }),
        });

        submitRequested = true;
      },
    });

    // 참가자 ID
    const subject_id = jsPsych.randomization.randomID(10);
    let participant_name = "";

    // -----------------------------
    // 2. 시작 화면: 이름만 입력
    // -----------------------------
    const name_screen = {
      type: jsPsychSurveyHtmlForm,
      preamble: `
        <h1 class="main-title">음악 감정 평가 실험 (파일럿)</h1>
        <div class="info-text" style="text-align:left;">
          아래에 <strong>본인 이름</strong>만 입력한 뒤 시작해 주세요.<br>
          * 중간에 나가시면 저장이 안됩니다. 한번에 끝까지 진행해 주세요!<br>
          * 조용한 곳에서 가장 편한 방법으로 들어주세요.<br>
          * 너무 오래 생각하지 마시고 직관적으로 평가해 주세요.
        </div>
      `,
      html: `
        <div class="info-text" style="text-align:left; margin-top:14px;">
          <label style="font-weight:600;">이름: </label>
          <input type="text" name="name" required placeholder="예: 홍길동" style="padding:6px 8px; width:280px; max-width:100%;">
        </div>
      `,
      button_label: "실험 시작하기",
      on_finish: function (data) {
        const resp = data.response || {};
        participant_name = (resp.name || "").trim();

        jsPsych.data.addProperties({
          subject_id: subject_id,
          name: participant_name,
        });
      },
    };

    // -----------------------------
    // 3. 자극 목록: 총 8곡 (파일명: calm_D01.wav 등)
    // -----------------------------
    const stimuli = [
      { file: "stims/calm_D01.wav",      base_emotion: "calm",  tag: "D" },
      { file: "stims/cheerful_D01.wav",  base_emotion: "cheerful",  tag: "D" },
      { file: "stims/calm_T01.wav",      base_emotion: "calm",  tag: "T" },
      { file: "stims/cheerful_T01.wav",  base_emotion: "cheerful",  tag: "T" },

      { file: "stims/tense_D01.wav",     base_emotion: "tense", tag: "D" },
      { file: "stims/sad_D01.wav",       base_emotion: "sad", tag: "D" },
      { file: "stims/tense_T01.wav",     base_emotion: "tense", tag: "T" },
      { file: "stims/sad_T01.wav",       base_emotion: "sad", tag: "T" },
    ];

    // 랜덤화 & seq 부여
    const shuffled_stimuli = jsPsych.randomization.shuffle(stimuli);
    shuffled_stimuli.forEach((s, idx) => { s.seq = idx + 1; });
    const TOTAL_TRIALS = shuffled_stimuli.length; // 8

    // -----------------------------
    // 4. 감정 슬라이더 라벨 (7개 유지)
    // -----------------------------
    const sliderEmotions = [
      { code: "cheerful", label: "즐거운 (cheerful)" },
      { code: "energetic", label: "에너지가 넘치는 (energetic)" },
      { code: "in_love", label: "사랑에 빠진 (in love)" },
      { code: "dreamy", label: "꿈꾸는 듯한 (dreamy)" },
      { code: "calm", label: "평온한 (calm)" },
      { code: "sad", label: "슬픈 (sad)" },
      { code: "tense", label: "불안한 (tense)" },
    ];

    // -----------------------------
    // 5. 곡 trial
    // -----------------------------
    const song_trial = {
      type: jsPsychSurveyHtmlForm,
      html: function () {
        const file = jsPsych.timelineVariable("file");
        const idx = jsPsych.timelineVariable("seq");

        const progressHTML = `
          <div class="progress-text">
            ${idx} / ${TOTAL_TRIALS}
          </div>
        `;

        let sliderHTML = "";
        sliderEmotions.forEach((em) => {
          sliderHTML += `
            <div class="slider-row">
              <div><strong>${em.label}</strong></div>
              <div class="slider-wrap">
                <input type="range" name="${em.code}" min="0" max="100" step="1" value="0" />
                <div class="mid-tick"></div>
              </div>
              <div class="slider-label-line">
                <span>전혀 느껴지지 않음 (0)</span>
                <span>매우 강하게 느껴짐 (100)</span>
              </div>
            </div>
          `;
        });

        const valenceSlider = `
          <div class="slider-row">
            <div><strong>Valence (정서가)</strong></div>
            <div class="slider-wrap">
              <input type="range" name="valence" min="0" max="100" step="1" value="50" />
              <div class="mid-tick"></div>
            </div>
            <div class="slider-label-line">
              <span>매우 부정적인 (0)</span>
              <span>매우 긍정적인 (100)</span>
            </div>
          </div>
        `;

        const arousalSlider = `
          <div class="slider-row">
            <div><strong>Arousal (각성도)</strong></div>
            <div class="slider-wrap">
              <input type="range" name="arousal" min="0" max="100" step="1" value="50" />
              <div class="mid-tick"></div>
            </div>
            <div class="slider-label-line">
              <span>매우 이완된, 차분한 (0)</span>
              <span>매우 각성된, 강렬한 (100)</span>
            </div>
          </div>
        `;

        return `
          ${progressHTML}

          <div class="top-instruction">
            <p>아래의 <strong>Play</strong> 버튼을 누르시면 음악이 재생됩니다. 필요하면 여러 번 들으실 수 있습니다.</p>
            <button type="button"
                    onclick="document.getElementById('audio-${idx}').play()"
                    class="jspsych-btn">Play</button>
            <audio id="audio-${idx}" src="${file}" preload="auto"></audio>
          </div>

          <h3 style="text-align:center; margin-top:18px;">
            음악을 들은 후, 아래의 <strong>감정 슬라이더</strong>와 <strong>Valence/Arousal</strong> 문항을 모두 평가해 주세요.
          </h3>

          <div class="trial-layout">
            <div class="left-pane">
              <fieldset>
                <legend>1. 이 음악에서 느껴지는 각 감정의 강도</legend>
                <p style="font-size:13px; margin-bottom:8px;">
                  각 감정들이 느껴지는 만큼 슬라이더로 표현해 주세요.
                </p>
                ${sliderHTML}
              </fieldset>
            </div>

            <div class="right-pane">
              <fieldset>
                <legend>2. Valence (정서가)</legend>
                <p style="font-size:13px;">
                  이 음악이 표현하는 감정의 정서가를 슬라이더로 표시해 주세요.
                </p>
                ${valenceSlider}
              </fieldset>

              <fieldset>
                <legend>3. Arousal (각성도)</legend>
                <p style="font-size:13px;">
                  이 음악이 표현하는 감정의 각성도를 슬라이더로 표시해 주세요.
                </p>
                ${arousalSlider}
              </fieldset>
            </div>
          </div>
        `;
      },
      button_label: "다음",
      data: {
        file: jsPsych.timelineVariable("file"),
        base_emotion: jsPsych.timelineVariable("base_emotion"),
        tag: jsPsych.timelineVariable("tag"),
        seq: jsPsych.timelineVariable("seq"),
      },

      on_load: function () {
        const idx = jsPsych.timelineVariable("seq");
        const audio = document.getElementById(`audio-${idx}`);
        const nextBtn = document.getElementById("jspsych-survey-html-form-next");

        let hasPlayed = false;

        if (audio) {
          audio.addEventListener("play", () => { hasPlayed = true; });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", function (e) {
            if (!hasPlayed) {
              e.preventDefault();
              e.stopPropagation();
              alert("Play 버튼을 눌러 음악을 들어주시고, 감정 평가를 해주세요.");
            }
          });
        }
      },

      on_finish: function (data) {
        const resp = data.response || {};
        sliderEmotions.forEach((em) => {
          const val = resp[em.code];
          data[em.code] = val !== undefined && val !== null ? Number(val) : null;
        });
        data.valence = resp.valence !== undefined && resp.valence !== null ? Number(resp.valence) : null;
        data.arousal = resp.arousal !== undefined && resp.arousal !== null ? Number(resp.arousal) : null;

        data.subject_id = subject_id;
        data.name = participant_name;
      },
    };

    const song_procedure = {
      timeline: [song_trial],
      timeline_variables: shuffled_stimuli,
      randomize_order: false,
    };

// -----------------------------
// ✅ 6. 주관식(자유응답) 페이지 + 청취 방식(필수, 기타 시 입력 필수)
// -----------------------------
const free_response = {
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <h1 class="main-title">자유 의견</h1>
    <div class="info-text" style="text-align:left;">
      아래 문항에 응답해 주세요.
    </div>
  `,
  html: `
    <fieldset>
      <legend style="font-weight:700;">어떤 방식으로 음악을 들으셨는지 체크해 주세요. (필수)</legend>

      <label style="display:block; margin: 10px 0;">
        <input type="radio" name="listening_method" value="블루투스" required>
        블루투스
      </label>

      <label style="display:block; margin: 10px 0;">
        <input type="radio" name="listening_method" value="스피커">
        스피커
      </label>

      <label style="display:block; margin: 10px 0;">
        <input type="radio" name="listening_method" value="헤드폰">
        헤드폰
      </label>

      <label style="display:block; margin: 10px 0;">
        <input type="radio" name="listening_method" value="기타" id="lm_other_radio">
        기타
      </label>

      <input
        type="text"
        name="listening_method_other"
        id="lm_other_text"
        placeholder="기타인 경우 여기에 입력해 주세요"
        style="padding:6px 8px; width:420px; max-width:100%;"
        disabled
      />
      <div style="font-size:12px; color:#555; margin-top:6px;">
        * ‘기타’를 선택한 경우 위 칸에 내용을 반드시 입력해 주세요.
      </div>
    </fieldset>

    <fieldset>
      <legend style="font-weight:700;">자유 의견 (선택)</legend>

      <div class="info-text" style="text-align:left; margin-top:6px;">
        <strong>질문:</strong> 이번 실험이나, 일상에서 듣는 음악 전반에 관련해 음악 감정에 대한 본인의 의견을 자유롭게 써주세요.<br><br>
        <span style="color:#444; font-size:12.5px;">
          (예시)<br>
          - 보통 음악의 ㅇㅇㅇ한 감정은 잘 느껴지는데, ㅇㅇㅇ한 감정은 잘 모르겠다.<br>
          - 전반적으로 이 실험에서 감정 평가를 하는 데 자신감이 없었다.<br>
          - 저번 첫 번째 실험과 달리~, 저번 실험과 비슷하게~ ㅇㅇㅇㅇ였다.<br>
          - ㅇㅇ한 특징이 있는 음악은 더 ㅇㅇ하게 느껴지는 것 같다. 등
        </span>
      </div>

      <div style="margin-top:14px;">
        <textarea class="textarea" name="free_comment"
          placeholder="여기에 자유롭게 작성해 주세요. (비워도 됩니다)"></textarea>
      </div>
    </fieldset>
  `,
  button_label: "마지막으로 제출하기",

  on_load: function () {
    const otherRadio = document.getElementById("lm_other_radio");
    const otherText  = document.getElementById("lm_other_text");
    const nextBtn    = document.getElementById("jspsych-survey-html-form-next");

    function updateOtherState() {
      const isOther = otherRadio && otherRadio.checked;
      if (!otherText) return;

      otherText.disabled = !isOther;

      // 기타 선택 시 required 강제 부여
      if (isOther) {
        otherText.setAttribute("required", "required");
        otherText.focus();
      } else {
        otherText.removeAttribute("required");
        otherText.value = "";
      }
    }

    // 라디오 변화 감지
    const radios = document.querySelectorAll('input[name="listening_method"]');
    radios.forEach(r => r.addEventListener("change", updateOtherState));

    // 초기 상태
    updateOtherState();

    // 플러그인/브라우저 조합에 따라 required가 경고 없이 넘어가는 걸 방지하는 "추가 안전장치"
    if (nextBtn) {
      nextBtn.addEventListener("click", function (e) {
        const selected = document.querySelector('input[name="listening_method"]:checked');
        if (!selected) {
          e.preventDefault();
          e.stopPropagation();
          alert("청취 방식을 선택해 주세요.");
          return;
        }

        if (selected.value === "기타") {
          const v = (otherText && otherText.value ? otherText.value.trim() : "");
          if (!v) {
            e.preventDefault();
            e.stopPropagation();
            alert("‘기타’를 선택하신 경우, 내용을 입력해 주세요.");
            return;
          }
        }
      });
    }
  },

  on_finish: function (data) {
    const resp = data.response || {};
    data.listening_method = (resp.listening_method || "").trim();
    data.listening_method_other = (resp.listening_method_other || "").trim();
    data.free_comment = (resp.free_comment || "").trim();
  },
};



    // -----------------------------
    // ✅ 7. 종료(제출 완료) 화면: 버튼 누르면 저장 완료 문구 표시
    // -----------------------------
    const outro = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>마지막 단계입니다.</h2>
        <p>아래 <strong>종료</strong> 버튼을 누르면 응답 제출이 완료됩니다.</p>
        <p style="font-size:12.5px; color:#444;">
          ※ 버튼을 누른 뒤, 완료 문구가 뜰 때까지 창을 닫지 말아주세요.
        </p>
      `,
      choices: ["종료 (꼭 눌러주세요)"],
      on_finish: function () {
        // 버튼 클릭 후, "완료" 화면으로 전환
        jsPsych.endExperiment(`
          <div style="max-width:720px; margin:120px auto; text-align:center; line-height:1.7;">
            <h2 style="margin-bottom:14px;">정상적으로 응답이 저장되었습니다.</h2>
            <p>실험에 참여해 주셔서 감사합니다.</p>
          </div>
        `);
      },
    };

    // -----------------------------
    // 8. 전체 실행
    // -----------------------------
    jsPsych.run([
      name_screen,
      song_procedure,
      free_response,  // ✅ 추가됨
      outro,
    ]);
  </script>
</body>
</html>
