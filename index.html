<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>음악 감정 평가 실험</title>

  <!-- jsPsych core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link
    href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css"
    rel="stylesheet"
    type="text/css"
  />

  <!-- plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>

  <style>
    body {
      max-width: 1100px;
      margin: 0 auto;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue",
        sans-serif;
    }

    h1.main-title {
      text-align: center;
      margin: 18px 8px 8px;
      font-size: 26px;
      line-height: 1.3;
    }

    fieldset {
      margin-bottom: 20px;
      border: 1px dashed #a0a0a0;
      padding: 12px 18px;
      border-radius: 6px;
      background: #fafafa;
    }

    legend {
      font-weight: 600;
      padding: 0 6px;
    }

    .trial-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      margin-top: 12px;
    }

    .left-pane {
      flex: 1.2;
      text-align: left;
    }

    .right-pane {
      flex: 1;
    }

    .top-instruction {
      text-align: center;
      margin-bottom: 10px;
      border: 1px dashed #ccc;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
    }

    .jspsych-btn {
      padding: 6px 16px;
    }

    .slider-row {
      margin: 8px 0 18px 0;
      font-size: 13px;
    }

    .slider-label-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
    }

    .slider-label-line span {
      flex: 1;
      text-align: center;
    }

    .slider-label-line span:first-child {
      text-align: left;
    }

    .slider-label-line span:last-child {
      text-align: right;
    }

    .slider-wrap {
      position: relative;
      width: 100%;
      margin-top: 6px;
    }

    .slider-wrap input[type="range"] {
      width: 100%;
      margin: 0;
    }

    .slider-wrap .mid-tick {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 130%;
      background: #777;
      pointer-events: none;
    }

    .progress-text {
      text-align: right;
      font-size: 13px;
      margin: 6px 4px 4px;
      color: #555;
    }

    .consent-text {
      font-size: 13px;
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .consent-input-row {
      margin: 10px 0;
      font-size: 13px;
    }

    .consent-input-row label {
      display: inline-block;
      min-width: 140px;
      font-weight: 600;
    }

    .consent-input-row input[type="text"] {
      width: 60%;
      max-width: 360px;
      padding: 6px 8px;
      font-size: 13px;
    }

    /* ✅ 모든 다음/종료 버튼을 화면 맨 아래와 띄우기 */
    #jspsych-survey-html-form-next {
      margin-bottom: 40px;
    }
    [id^="jspsych-html-button-response-button"] {
      margin-bottom: 40px;
    }

    @media (max-width: 900px) {
      .trial-layout {
        flex-direction: column;
      }
      .left-pane,
      .right-pane {
        width: 100%;
      }

      .consent-input-row label {
        display: block;
        margin-bottom: 6px;
      }

      .consent-input-row input[type="text"] {
        width: 100%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <script>
    // -----------------------------
    // 0. Google Apps Script 웹앱 URL
    // -----------------------------
    const SUBMIT_URL =
      "https://script.google.com/macros/s/AKfycby_zNl794B9edEQjZ89m3hhqgPHtcbmEgSss8JhsfgjsMQMooTZ1i5dJ7TwN_7PzS2K/exec";

    // -----------------------------
    // 1. jsPsych 초기화
    // -----------------------------
    const jsPsych = initJsPsych({
      display_element: "jspsych-target",
      on_finish: function () {
        const csv = jsPsych.data.get().csv();

        const now = new Date();
        const submitted_at = now.toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
        const submitted_iso = now.toISOString();

        fetch(SUBMIT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            subject_id: subject_id,
            name: participant_name,   // ✅ 이름도 같이 저장
            csv: csv,
            submitted_at: submitted_at,
            submitted_iso: submitted_iso,
          }),
        });
      },
    });

    // 참가자 ID 생성
    const subject_id = jsPsych.randomization.randomID(10);

    // 이름 변수(시작 화면에서 채움)
    let participant_name = "";

    // -----------------------------
    // 1-0. 시작: 이름만 입력
    // -----------------------------
    const name_screen = {
      type: jsPsychSurveyHtmlForm,
      preamble: `
        <h1 class="main-title">음악 감정 평가 실험</h1>
        <p class="consent-text" style="text-align:left; margin-top:14px;">
          아래에 <strong>본인 이름</strong>만 입력한 뒤 시작해 주세요.<br>
          * 중간에 나가시면 저장이 안됩니다. 한번에 끝까지 진행해 주세요!<br>
          * 조용한 곳에서 가장 편한 방법으로 들어주세요.<br>
          * 너무 오래 생각하지 마시고 직관적으로 평가해 주세요.
        </p>
      `,
      html: `
        <div class="consent-input-row">
          <label>이름 :</label>
          <input type="text" name="name" required placeholder="예: 홍길동">
        </div>
      `,
      button_label: "실험 시작하기",
      on_finish: function (data) {
        const resp = data.response || {};
        participant_name = (resp.name || "").trim();

        jsPsych.data.addProperties({
          subject_id: subject_id,
          name: participant_name,
        });
      },
    };

    // -----------------------------
    // 2. 자극 목록 준비 (✅ 총 40개로 변경)
    //    4 emotions × 2 tags(C,S) × 5 = 40
    // -----------------------------
    const emotionGroups = ["calm", "cheerful", "sad", "tense"]; // ✅ 4개만 사용

    let stimuli = [];
    let seqCounter = 1;

    emotionGroups.forEach((em) => {
      ["C", "S"].forEach((tag) => {
        for (let i = 1; i <= 5; i++) {
          const num = String(i).padStart(2, "0");
          stimuli.push({
            file: `stims/${em}_${tag}${num}.mp3`,
            base_emotion: em,
            variant: `${tag}${num}`,
            seq: seqCounter,
          });
          seqCounter++;
        }
      });
    });

    // 랜덤 순서
    stimuli = jsPsych.randomization.shuffle(stimuli);

    // seq 다시 부여
    stimuli.forEach((s, idx) => {
      s.seq = idx + 1;
    });

    const TOTAL_TRIALS = stimuli.length; // ✅ 40

    // -----------------------------
    // 3. 감정 슬라이더 라벨
    // -----------------------------
    const sliderEmotions = [
      { code: "cheerful", label: "즐거운 (cheerful)" },
      { code: "energetic", label: "에너지가 넘치는 (energetic)" },
      { code: "in_love", label: "사랑에 빠진 (in love)" },
      { code: "dreamy", label: "꿈꾸는 듯한 (dreamy)" },
      { code: "calm", label: "평온한 (calm)" },
      { code: "sad", label: "슬픈 (sad)" },
      { code: "tense", label: "불안한 (tense)" },
    ];

    // -----------------------------
    // 4. 한 곡당 한 화면 trial
    // -----------------------------
    const song_trial = {
      type: jsPsychSurveyHtmlForm,
      html: function () {
        const file = jsPsych.timelineVariable("file");
        const idx = jsPsych.timelineVariable("seq");

        const progressHTML = `
          <div class="progress-text">
            곡 ${idx} / ${TOTAL_TRIALS}
          </div>
        `;

        let sliderHTML = "";
        sliderEmotions.forEach((em) => {
          sliderHTML += `
            <div class="slider-row">
              <div><strong>${em.label}</strong></div>
              <div class="slider-wrap">
                <input type="range"
                       name="${em.code}"
                       min="0" max="100" step="1" value="0" />
                <div class="mid-tick"></div>
              </div>
              <div class="slider-label-line">
                <span>전혀 느껴지지 않음 (0)</span>
                <span>매우 강하게 느껴짐 (100)</span>
              </div>
            </div>
          `;
        });

        const valenceSlider = `
          <div class="slider-row">
            <div><strong>Valence (정서가)</strong></div>
            <div class="slider-wrap">
              <input type="range" name="valence" min="0" max="100" step="1" value="50" />
              <div class="mid-tick"></div>
            </div>
            <div class="slider-label-line">
              <span>매우 부정적인 (0)</span>
              <span>매우 긍정적인 (100)</span>
            </div>
          </div>
        `;

        const arousalSlider = `
          <div class="slider-row">
            <div><strong>Arousal (각성도)</strong></div>
            <div class="slider-wrap">
              <input type="range" name="arousal" min="0" max="100" step="1" value="50" />
              <div class="mid-tick"></div>
            </div>
            <div class="slider-label-line">
              <span>매우 이완된, 차분한 (0)</span>
              <span>매우 각성된, 강렬한 (100)</span>
            </div>
          </div>
        `;

        return `
          ${progressHTML}

          <div class="top-instruction">
            <p>아래의 <strong>Play</strong> 버튼을 누르시면 음악이 재생됩니다. 필요하면 여러 번 들으실 수 있습니다.</p>
            <button type="button"
                    onclick="document.getElementById('audio-${idx}').play()"
                    class="jspsych-btn">
              Play
            </button>
            <audio id="audio-${idx}" src="${file}" preload="auto"></audio>
          </div>

          <h3 style="text-align:center; margin-top:18px;">
            음악을 들은 후, 아래의 <strong>감정 슬라이더</strong>와 <strong>Valence/Arousal</strong> 문항을 모두 평가해 주세요.
          </h3>

          <div class="trial-layout">
            <div class="left-pane">
              <fieldset>
                <legend>1. 이 음악에서 느껴지는 각 감정의 강도</legend>
                <p style="font-size:13px; margin-bottom:8px;">
                  각 감정들이 느껴지는 만큼 슬라이더로 표현해 주세요.
                </p>
                ${sliderHTML}
              </fieldset>
            </div>

            <div class="right-pane">
              <fieldset>
                <legend>2. Valence (정서가)</legend>
                <p style="font-size:13px;">
                  이 음악이 표현하는 감정의 정서가를 슬라이더로 표시해 주세요.
                </p>
                ${valenceSlider}
              </fieldset>

              <fieldset>
                <legend>3. Arousal (각성도)</legend>
                <p style="font-size:13px;">
                  이 음악이 표현하는 감정의 각성도를 슬라이더로 표시해 주세요.
                </p>
                ${arousalSlider}
              </fieldset>
            </div>
          </div>
        `;
      },
      button_label: "다음 곡으로",
      data: {
        file: jsPsych.timelineVariable("file"),
        base_emotion: jsPsych.timelineVariable("base_emotion"),
        variant: jsPsych.timelineVariable("variant"),
        seq: jsPsych.timelineVariable("seq"),
      },

      // "Play를 한 번이라도 눌렀는지" 검사
      on_load: function () {
        const idx = jsPsych.timelineVariable("seq");
        const audio = document.getElementById(`audio-${idx}`);
        const nextBtn = document.getElementById("jspsych-survey-html-form-next");

        let hasPlayed = false;

        if (audio) {
          audio.addEventListener("play", () => {
            hasPlayed = true;
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", function (e) {
            if (!hasPlayed) {
              e.preventDefault();
              e.stopPropagation();
              alert("Play 버튼을 눌러 음악을 들어주시고, 감정 평가를 해주세요.");
            }
          });
        }
      },

      on_finish: function (data) {
        const resp = data.response || {};
        sliderEmotions.forEach((em) => {
          const val = resp[em.code];
          data[em.code] = val !== undefined && val !== null ? Number(val) : null;
        });
        data.valence = resp.valence !== undefined && resp.valence !== null ? Number(resp.valence) : null;
        data.arousal = resp.arousal !== undefined && resp.arousal !== null ? Number(resp.arousal) : null;

        // 혹시 추후 분석 편하게 이름/subject_id도 각 trial에 남기고 싶으면:
        data.subject_id = subject_id;
        data.name = participant_name;
      },
    };

    const song_procedure = {
      timeline: [song_trial],
      timeline_variables: stimuli,
      randomize_order: false,
    };

    // -----------------------------
    // 5. 종료 화면
    // -----------------------------
    const outro = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>실험이 완료되었습니다.</h2>
        <p>참여해 주셔서 감사합니다.</p>
        <p>종료 버튼을 누르면 응답이 저장됩니다.</p>
      `,
      choices: ["종료 (꼭 눌러주세요)"],
    };

    // -----------------------------
    // 6. 전체 타임라인 실행
    // -----------------------------
    jsPsych.run([
      name_screen,
      song_procedure,
      outro,
    ]);
  </script>
</body>
</html>
